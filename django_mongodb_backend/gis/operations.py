from django.contrib.gis import geos
from django.contrib.gis.db import models
from django.contrib.gis.db.backends.base.operations import BaseSpatialOperations
from django.contrib.gis.measure import Distance
from django.db.backends.base.operations import BaseDatabaseOperations

from .adapter import Adapter
from .operators import (
    Contains,
    Disjoint,
    DistanceGT,
    DistanceGTE,
    DistanceLT,
    DistanceLTE,
    DWithin,
    Intersects,
    Within,
)


class GISOperations(BaseSpatialOperations, BaseDatabaseOperations):
    Adapter = Adapter

    disallowed_aggregates = (
        models.Collect,
        models.Extent,
        models.Extent3D,
        models.MakeLine,
        models.Union,
    )

    operators = {
        "contains": Contains(),
        "intersects": Intersects(),
        "disjoint": Disjoint(),
        "within": Within(),
        "distance_gt": DistanceGT(),
        "distance_gte": DistanceGTE(),
        "distance_lt": DistanceLT(),
        "distance_lte": DistanceLTE(),
        "dwithin": DWithin(),
    }

    @property
    def gis_operators(self):
        return self.operators

    unsupported_functions = {
        "Area",
        "AsGeoJSON",
        "AsGML",
        "AsKML",
        "AsSVG",
        "AsWKB",
        "AsWKT",
        "Azimuth",
        "BoundingCircle",
        "Centroid",
        "ClosestPoint",
        "Difference",
        "Distance",
        "Envelope",
        "ForcePolygonCW",
        "FromWKB",
        "FromWKT",
        "GeoHash",
        "GeometryDistance",
        "Intersection",
        "IsEmpty",
        "IsValid",
        "Length",
        "LineLocatePoint",
        "MakeValid",
        "MemSize",
        "NumGeometries",
        "NumPoints",
        "Perimeter",
        "PointOnSurface",
        "Reverse",
        "Scale",
        "SnapToGrid",
        "SymDifference",
        "Transform",
        "Translate",
        "Union",
    }

    def geo_db_type(self, f):
        return "object"

    def get_geometry_converter(self, expression):
        srid = expression.output_field.srid

        def converter(value, expression, connection):  # noqa: ARG001
            if value is None:
                return None

            geom_class = getattr(geos, value["type"])
            if geom_class.__name__ == "GeometryCollection":
                return geom_class(
                    [
                        getattr(geos, v["type"])(*v["coordinates"], srid=srid)
                        for v in value["geometries"]
                    ],
                    srid=srid,
                )
            if issubclass(geom_class, geos.GeometryCollection):
                sub_geom_class = geom_class._allowed
                # MultiLineString allows both LineString and LinearRing but should be
                # initialized with LineString.
                if isinstance(sub_geom_class, tuple):
                    sub_geom_class = sub_geom_class[0]
                return geom_class(
                    [
                        sub_geom_class(*value["coordinates"][x])
                        for x in range(len(value["coordinates"]))
                    ],
                    srid=srid,
                )
            return geom_class(*value["coordinates"], srid=srid)

        return converter

    def get_distance(self, f, value, lookup_type):
        value = value[0]
        if isinstance(value, Distance):
            if f.geodetic(self.connection):
                raise ValueError(
                    "Only numeric values of radian units are allowed on geodetic distance queries."
                )
            dist_param = getattr(value, Distance.unit_attname(f.units_name(self.connection)))
        else:
            dist_param = value
        return [dist_param]
